<!DOCTYPE html>
<html>
  <head>
    <title>Hackathon mapping</title>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDXGj48qODguMHJM9lPXyl_-iWUlhp-cxg&callback=initMap&libraries=&v=weekly"
      defer></script>

<script>

var ships = {}		// ID->{marker}

function initMap() {

	// First lets setup the map
	const map = new google.maps.Map(document.getElementById("map"), {
		zoom: 9,
		center: { lat: 52.179413, lng: 0.919274 },
		mapTypeId: "terrain",
	});

	// Now listen on a websocket for events...

	socket = new WebSocket("ws://localhost:3000/ws")

	// Connection opened
	socket.addEventListener('open', function (event) {
		socket.send('Hello Server!');
	});

	// Listen for messages
	socket.addEventListener('message', function (event) {

		// Do an update...
		bits = event.data.split(" ")
		// ID lat lon
		id = bits[0]
		lat = bits[1]
		lon = bits[2]
		console.log('Message from server ', event.data);

		if (typeof(ships[id])=='undefined') {
			console.log("NEW SHIP! " + id)
			var marker = new google.maps.Marker({
				map: map,
				position: new google.maps.LatLng(lat, lon),
				title: "Ship " + id
			});
			ships[id] = marker
		} else {
			marker = ships[id]
			var latlng = new google.maps.LatLng(lat, lon);
			marker.setPosition(latlng)
		}
	});

	// Connection closed
	socket.addEventListener('close', function (event) {
		socket.send('Bye Server!');
	});

	/*
	lat = 52.214016
	lon = 0.964676

		var marker = new google.maps.Marker({
			map: map,
			position: new google.maps.LatLng(lat, lon),
			title: "Ship1"
		});

	setInterval(function() {
		// Draw some bits...

		lat += (Math.random() * .01) - .005
		lon += (Math.random() * .01) - .005
		var latlng = new google.maps.LatLng(lat, lon);
		marker.setPosition(latlng)

	}, 100)
	*/
}
</script>

<style>
/* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
#map {
  height: 100%;
}

/* Optional: Makes the sample page fill the window. */
html,
body {
  height: 100%;
  margin: 0;
  padding: 0;
}
</style>
  </head>
  <body>
    <div id="map"></div>
  </body>
</html>
